---
title: "Module 4 Final Project — Milestone 2: Draft Report"
author: Abby Bridgers and Justin Ehringhaus
date: Last edited `r format(Sys.time(), '%B %d, %Y')` at `r format(Sys.time(), '%H:%M')`
output:
  html_document: 
    toc: true
    toc_depth: 5
  # github_document: default
  #  toc: true
bibliography: "references.bib"
nocite: '@*'
---

---

```{r setup, include=FALSE}
# repo: https://github.com/ab6723/aly6040_V02
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(pacman)
p_load(tidyverse)  # usual suite of packages
p_load(ggthemes)   # extra themes
p_load(hrbrthemes) # more extra themes
p_load(skimr)      # alternative to summary(), skims dataset: skim()
p_load(VIM)        # visualization of missing values: aggr()
p_load(corrplot)   # visualization of a correlation matrix: corrplot()
p_load(maps)       # world map
p_load(rattle)
p_load(rpart, rpart.plot)
p_load(caret)
```

---

## Introduction

##### Overview

The World Values Survey (WVS) aims to understand the values, beliefs, and norms of people all over the world, comparatively and longitudinally. Operating in more than 120 countries and conducted every five years, the WVS uses a common questionnaire and household interview format to investigate human beliefs. The data is made available in waves, where the most recent Wave 7 represents interviews conducted between 2017-2022. Time series data including all waves pooled between 1981-2022 is also available.

While examining the pooled dataset would certainly be interesting to answer questions about the changes worldwide in people’s values, beliefs, and norms, we are opting to limit the scope of our project to recent years (Wave 7: 2017-2022). Already, the size and scope of this dataset represents a big step for our group’s budding data analysts, as we have never yet worked with anything so faceted. The Wave 7 dataset is wide, containing 552 variables and 87,822 rows.  We reduced the number of attributes by about 90%. More details follow.

Our team (Abby Bridgers and Justin Ehringhaus) are interested in how universal certain values are as well as how values differentiate across the globe. Abby is hoping to learn specifically about values on immigration, and Justin is hoping to learn specifically about social views and ethical values. 

##### Missing data? Duplicates? Cleanliness? Outliers?

While there was missing data found in our dataset, we elected to refrain from cleaning the data because doing so may unintentionally falsify the results of the WVS survey. In a typical data cleaning process, outliers are removed to concentrate on the central tendency of the data. Missing data is removed and/or standardized for numerical analysis. Since our data is ordinal, and we are interested in including and analyzing the data holistically, we did not feel that it would be appropriate to "clean" the data beyond changing column names, selecting attributes of interest, and ensuring that there was not a prohibitory amount of NA values found in our subsets of interest.

##### Methods

We analyze particular subsets of the dataset using decision tree analysis. We chose decision tree because of our restriction to ordinal (Likert) data; we have a select few attributes of numerical data, but they're primarily demographic information as opposed to data on values, which is our point of interest. Therefore, we decided to orient our analysis around a deep-dive on decision trees. We completed four decision trees inspired by the four business questions listed below, which drawn from our exploratory data analysis insights and interests. 

##### Business questions

- #2: Predicting the religious affiliation of an individual given their social views and ethical values.
- #3: Predicting the happiness of an individual given demographic information.
- #4: Predicting the immigration views, social views, and ethical values of an individual.
- #5: The relationship between confidence in the United Nations (Q83), elections (Q76), and the courts (Q70)
- The relationship between income (Q288), happiness (Q46), and health (Q47).
- The relationship between marital status (Q273) and political engagement (Q209 - Q222).
- The relationship between religious denomination (Q289) and number of children (Q274).
- The differences in ethical values (Q177-Q195) by ethnic group (Q290).
- The relationship between immigration stance (122:130) and age (262).
- The relationship between education completed (Q275) and the importance of leisure time (Q3).

---

## Data Preparation

```{r message=FALSE, warning=FALSE}
# importing the entire dataset
wvs <- read_csv("../WVS_Cross-National_Wave_7_csv_v4_0.csv")

# checking first few rows and columns for import success
head(wvs)[,1:5]
```

```{r}
wvs_subset <- 
  wvs %>% 
  select(
    # --------------------------- DEMOGRAPHICS
    Country = B_COUNTRY_ALPHA,
    Longitude = O1_LONGITUDE,
    Latitude = O2_LATITUDE,
    Settlement.type = H_SETTLEMENT,
    Country.and.year = S025,
    Town.size = G_TOWNSIZE2,
    Age = Q262,
    Income.Group = Q288,
    Ethnic.Group = Q290, # see WVS_codebook.pdf for Q290 coding info
    Immigrant = Q263,
    Religion = Q289,
    Marital.Status = Q273,
    Education = Q275,
    Number.Children = Q274,
    Happiness = Q46,
    Health = Q47,
    # --------------------------- POLITICAL PARTICIPATION / CONFIDENCE IN GOVERNMENT
    votes.locally = Q221,
    votes.nationally = Q222,
    confidence.elections = Q76,
    confidence.courts = Q70,
    confidence.UN = Q83,
    environment.vs.econgrow = Q111,
    # --------------------------- RELATIONSHIP BETWEEN GOVERNMENT AND CITIZENS
    cheating.taxes = Q180,
    gov.video.surveillance = Q196,
    gov.email.monitoring = Q197,
    gov.collecting.info = Q198,
    # --------------------------- ETHICAL VALUES ---------------------------
    terrorism = Q192,
    death.penalty = Q195,
    suicide = Q187,
    beating.wife = Q189,
    beating.children = Q190,
    # --------------------------- SOCIAL VIEWS ---------------------------
    homosexuality = Q182,
    prostitution = Q183,
    abortion = Q184,
    divorce = Q185,
    casual.sex = Q193,
    sex.before.marriage = Q186,
    # --------------------------- CAREER VALUES ---------------------------
    importance.leisure.time = Q3,
    importance.work = Q5,
    # --------------------------- IMMIGRATION ---------------------------
    job.scarc.prioritizes.nonimm = Q34,
    imm.fills.useful.jobs = Q122,
    imm.strengthens.cultural.div = Q123,
    imm.increases.crime.rate = Q124,
    imm.gives.political.asylum = Q125,
    imm.increases.terrorism.risk = Q126,
    imm.helps.poor = Q127,
    imm.increases.unemployment = Q128,
    imm.brings.social.conflict = Q129,
    imm.policy.preference = Q130
    )
```

---

## Exploratory Data Analysis

```{r}
myskim <- skim(wvs_subset)
myskim
```

The subset of the dataset contains `r nrow(wvs_subset)` rows and `r ncol(wvs_subset)` columns.

Most variables are numeric; only `Country` is classified as a character vector. `Longitude` and `Latitude` are missing the most data with a completion rate of `r myskim$complete_rate[2]`, but overall the mean completion rate is `r mean(myskim$complete_rate)`, which signifies that missing data is not too much of an issue for the particular variables under consideration.

As many of the variables are Likert scales (ordinal), the descriptive statistics generated by the skim give an indication of the distribution and the characteristics of the data. However, certain variables such as `Ethnic.Group`, `Country.and.year`, `Longitude`, and `Latitude` contain nominal, numeric data, and thus the descriptive statistics generated should be ignored.

```{r}
# ordinal, numeric data only 
wvs_subset_ordinal <- 
  wvs_subset %>% 
  select(-Longitude,
         -Latitude,
         -Country, 
         -Ethnic.Group, 
         -Country.and.year,
         -Religion)

# assessing correlations between ordinal, numeric data
# only including data where pairwise observations are complete (i.e., not including missing data)
cor <- cor(wvs_subset_ordinal, use = "pairwise.complete.obs")
corrplot(cor, 
         method = "circle", 
         insig = "blank", 
         diag = FALSE,
         tl.cex = 0.5) %>% 
    corrRect(name = c('Settlement.type', 
                      'votes.locally', 
                      'cheating.taxes', 
                      'terrorism', 
                      'homosexuality',
                      'importance.leisure.time',
                      'job.scarc.prioritizes.nonimm',
                      'imm.policy.preference'))
```

The visualization of a correlation matrix above indicates the extent to which each variable, compared to one another, correlates or relates. Darker blue colors represent stronger positive correlations, and darker orange colors represent stronger negative correlations. For visualization purposes, we have bucketed the variables into four groups, albeit it must be noted that by doing so we risk imposing structure where it does not, or should not, exist: 

- The first bucket contains variables relating to demographics
- The second relates to political participation / confidence in government
- The third relates to the relationship between government and citizens
- The fourth relates to ethical values
- The fifth relates to social views
- The sixth relates to career values
- The seventh relates to immigration

There are endless conversations that could be held based off this visualization of a correlation matrix. Some key insights are as follows:

- All variables in the fifth bucket (social views) are strongly correlated. This makes sense, as those with similar social views are generally split along the lines of liberal versus conservative thought. For example, it makes sense that those who hold conservative views on sexuality also hold conservative views on marriage, career, and government.
- Education is positively correlated with liberal social views (i.e., higher education = more liberal social views).
- Number of children is negatively correlated with liberal social views (i.e., more children = more conservative social views).
- Education is negatively correlated with number of children (i.e., higher education = less children).
- Voting locally or nationally is negatively correlated with age (i.e., older people participate more in politics).
- Views on terrorism positively correlate with views on domestic abuse (i.e., those who view terrorism favorably also view domestic abuse favorably).
- There is a moderate correlation between two questions on immigration. In the immigration questions, respondents were asked to answered their degree of agreement with statements. The moderately positively correlated statements are "Immigration in my country increases crime rate" and "immigration in my country brings social conflict." These questions are answered on the same ordinal scale of 3 options: "disagree", "hard to say", and "agree". 
- There is a strong negative correlation between settlement type and town size which are both on a 5-point scale. A response of "1" to the town size question means the respondent lives in a town of under 5,000 people. A response of "1" to the settlement type question means the respondent lives in the capital city of their country. Therefore, there is a strong inverse relationship between these two attributes.

Having understood how different variables correlate, we can transition to applying data mining techniques to answering our business questions.

---

## Data Mining Techniques and Interpretations

... explain reason for choosing decision tree / what business question(s) we hope to answer using this approach ...

In the tolerance tree, we sought to explore attitudes towards immigration in relation to a key value: tolerance. By setting up a decision tree with two questions on immigration that are in some ways in conflict with one another, we sought to answer the question, "how do those who believe tolerance is an important teaching for children feel about immigrants in their immediate lives, and more broadly, as a threat to security?" The two variables employed to answer this question are to the effect of, "does immigration increase the risk of terrorism?" and "would you like to have immigrants as neighbors?"

#### Business Question #4: Predicting the immigration views, social views, and ethical values of an individual. 
The following decision tree predicts the importance of teaching children tolerance based on 2 immigration viewpoints: friendliness towards immigrants as neighbors, and whether immigration increases the risk of terrorism. Decision tree was chosen as the mode of analysis because it provides a thorough answer to the question of whether those who emphasize tolerance to their children display tolerance towards immigrants in their home country.

```{r}
# sub-setting data
tree_subset <- 
  wvs %>% 
  select(Immigrants.As.Neighbors = Q21, # 1 = mentioned they wouldn't like this,                                             2 = didn't mention
        Tolerance.Important.For.Children = Q12, # 1 = mentioned to be important,                                                     2 = didn't mention
        Immigration.Increases.Terrorism.Risk = Q126) # 2 = agree, 1 = unsure, 0 = disagree
# skim
tree_skim <- skim(tree_subset)
# prop tables
prop.table(table(tree_subset$Immigrants.As.Neighbors)) # 1 = mentioned they wouldn't like this,                                                  2 = didn't mention
prop.table(table(tree_subset$Tolerance.Important.For.Children)) # 1 = mentioned to be important,                                                      2 = didn't mention
prop.table(table(tree_subset$Immigration.Increases.Terrorism.Risk)) # 2 = agree, 1 = unsure,                                                                     0 = disagree
# partition prep
set.seed(1000)
# remove NAs
tree_subset <- na.omit(tree_subset)
# partition
data_partition<-createDataPartition(y=tree_subset$Tolerance.Important.For.Children, p=0.8, list=FALSE)
train <- na.omit(tree_subset[data_partition,])
test <- tree_subset[-data_partition,]
# checking partition and NA omits
nrow(tree_subset)
nrow(train)
nrow(test)
head(train)
# tree plotting
library(rpart)
tolerance_tree <- rpart(formula = Tolerance.Important.For.Children ~., 
                 data = train,
                 method = 'class',
                #minsplit=2,
                cp=-1,
                 #minbucket = 2,
                #parms = list(split = 'gini')
                )

summary(tolerance_tree)

# tree visualization
library(rattle)
library(rpart.plot)
fancyRpartPlot(tolerance_tree, caption = "Predicting Importance of Teaching Children Tolerance Based on Immigration Viewpoints")
# Immigrants as neighbors: 1 = wouldn't like  2 = didn't mention
                           #0.2199076           0.7800924
# Tolerance important for children: 1 = yes   2 = didn't mention 
                                  # 0.6282186    0.3717814
# Immigration increases terrorism risk: # 2 = agree, 1 = unsure, 0 = disagree
                                        # 0.4558246,  0.2214990,  0.3226764

# Variable of importance
tolerance_tree$variable.importance # immigrants as neighbors

# Test variable prediction
tree_pred<-predict(tolerance_tree,newdata=test,
                   type = 'class',
                   prob = TRUE)

# Measure model performance
library(caret)
table(tree_pred, test$Tolerance.Important.For.Children)
confusionMatrix(as.factor(tree_pred), as.factor(test$Tolerance.Important.For.Children))
# 63% accuracy. Decision trees tend to over fit accuracy without extensive preparation to the training and test partitions.
```
#### Findings
It may be assumed that immigration viewpoints would be a strong predictor of importance of teaching children tolerance. If people view immigrants as an important aspect of their home home country culture and communities, we would likely describe them as tolerant, among other things. Therefore, analyzing the results of the decision tree with one positive question about immigration and one negative, it's interesting to see the results on the leaves, which all land close the 50/50 line, with tolerance being important teaching for children holding the majority in each leaf. 

#### Tolerance Importance: Leaf Interpretation (L-R)
* The vast majority of respondents - *78%* - are neutral of positive about the prospect of having neighbors that have immigrated from other countries.
* Of these 78%, 34% of respondents are neutral or positive about immigrants as neighbors, and responded that immigration increases the risk of terrorism. I'll classify this group as somewhat supportive of immigration (open to immigration in their immediate community and wary of immigration in their country). Within this leaf, 65% believe in the importance of teaching children tolerance (the highest among the leaves).
* 27% are neutral or positive about immigrants as neighbors, and disagree that immigration increases the risk of terrorism. I'll classify this group as most open to immigration. Within this leaf, 64% believe in the importance of teaching tolerance to children.
* 18% are neutral or positive about immigrants as neighbors, and unsure about the risk they pose to terrorism. This group is neutral. 
* Within the much smaller cohort that responded that they wouldn't like having immigrants as neighbors - *22%* - 10% are neutral or disagree with the question of whether immigiration increases the risk of terrorism. I'll include this group in the somewhat supportive of immigration category. This group also believes in teaching tolerance to children, though by a slim margin of about 6%. 
* In contrast, 12% of respondents agree that immgiration increases the risk of terrorism, and responded negatively to the idea of being neighbors with immigrants. This group is classified as the most unfavorable to immigration. Still, 59% of this group believes in teaching tolerance to children.

###### Based on this classification system, respondents fall into the following categories regarding immigration viewpoints: 27% are very supportive, 44% are somewhat supportive, 18% are neutral or unsure, and 12% are not supportive. The question of whether those who emphasize tolerance to their children display tolerance towards immigrants in their home country is answered; every category classified by immigration viewpoints, including those with negative attitudes, responded that they believe in teaching tolerance to children.

### Business Question #2: Predicting the religious affiliation of an individual given social views and ethical values.

... talk about reason for choosing decision tree for this particular question ...

```{r}
religion_tree <-
  wvs_subset %>% 
  select(-Longitude, -Latitude, -Country.and.year, -Ethnic.Group, -Country)

# partition prep
set.seed(888)
# remove NAs
religion_tree <- na.omit(religion_tree)

# partition
religion_tree_partition <- createDataPartition(y = religion_tree$Religion, p = 0.8, list = FALSE)
religion_tree_train <- na.omit(religion_tree[religion_tree_partition, ])
religion_tree_test <- religion_tree[-religion_tree_partition, ]

# building the classification tree with rpart
religion_tree_model <- rpart(formula = Religion ~ .,
                             data = religion_tree_train,
                             method = "class")

summary(religion_tree_model)

# Visualize the decision tree with rpart.plot
rpart.plot(religion_tree_model, nn = TRUE)
fancyRpartPlot(religion_tree_model, 
               main = "Predicting Religious Denomination\n-- a question of social views and town size --",
               caption = "0 = None\n1 = Roman Catholic\n5 = Muslim",
               type = 5)
```

`sex.before.marriage` = 
`Town.size` = 
`homosexuality` = 

# Religions:
# 0 = Do not belong to a denomination
# 1 = Roman Catholic
# 5 = Muslim
# Unused: Protestant, Orthodox (Russian/Greek/etc.), Jew, Hindu, Buddhist, Other

# Sex Before Marriage: scale from 1 (never justifiable) to 10 (always justifiable)
# Homosexuality: scale from 1 (never justifiable) to 10 (always justifiable)

# Interpretation:
# 62% of those who think sex before marriage is slightly justifiable do not have a religion
# 38% of those who think sex before marriage is never justifiable have a religion
# Of those having a religion, the line is split along views on homosexuality:
#     - 4% of those who think homosexuality is justifiable are Roman Catholics
#     - 34% of those who think homosexuality is not justifiable are Muslim

```{r}
#Testing the model
pred_religion_tree_model <- predict(object = religion_tree_model, religion_tree[-6], type = "class")
religion_tree_model_matrix <- table(religion_tree$Religion, pred_religion_tree_model)
confusionMatrix(religion_tree_model_matrix)
```

... talk about accuracy ...

### Business Question #3: Predicting whether an immigrant or nonimmigrant

... talk about reason for choosing decision tree for this particular question ...

```{r}
immigrant_tree <- 
  wvs_subset %>% 
  select(-Longitude, -Latitude, -Country.and.year, -Ethnic.Group, -Country)

# partition prep
set.seed(888)
# remove NAs
immigrant_tree <- na.omit(immigrant_tree)

# partition
immigrant_tree_partition <- createDataPartition(y = immigrant_tree$Immigrant, p = 0.8, list = FALSE)
immigrant_tree_train <- na.omit(immigrant_tree[immigrant_tree_partition, ])
immigrant_tree_test <- immigrant_tree[-immigrant_tree_partition, ]

# building the classification tree with rpart
immigrant_tree_model <- rpart(formula = Immigrant ~ .,
                              data = immigrant_tree_train,
                              method = "class")

summary(immigrant_tree_model)

# Visualize the decision tree with rpart.plot
fancyRpartPlot(immigrant_tree_model, 
               main = "Predicting Immigrant Status\n-- a question of political participation, immigration beliefs, and age --",
               caption = "",
               type = 5)
```

`votes.locally` = 1 (always) to 4 (not allowed)
`job.scarc.prioritizes.nonimm` = 1 (agree strongly) to 5 (disagree strongly)
`Age` = ...
`votes.nationally` = 1 (always) to 4 (not allowed)"

```{r}
#Testing the model
pred_immigrant_tree_model <- predict(object = immigrant_tree_model, immigrant_tree[-5], type = "class")
immigrant_tree_model_matrix <- table(immigrant_tree$Immigrant, pred_immigrant_tree_model)
confusionMatrix(immigrant_tree_model_matrix)
```

... talk about accuracy ...

## Business Question #5: The relationship between confidence in the United Nations (Q83), elections (Q76), and the courts (Q70).
The following decision tree answers the question of whether those who have faith in elections also have faith in the courts, and the United Nations (UN). Elections operate as the bedrock of democracy, but in countries without democracy, elections are often futile (or at least perceived to be). Therefore, it's worthwhile and interesting to assess the relationship, if any, between confidence in these 3 organizations. A decision tree was chosen for this reason, and because these questions were answered on the same Likert scale, making for a clearer classification from the algorithm.

```{r}
tree_four <- 
  wvs_subset %>% 
  select(-Longitude, -Latitude, -Country.and.year, -Ethnic.Group, -Country)

# partition prep
set.seed(1200)

# remove NAs
tree_four <- na.omit(tree_four)

# partition
four_partition <- createDataPartition(y = tree_four$confidence.elections, p = 0.8, list = FALSE)
four_train <- na.omit(tree_four[four_partition, ])
four_test <- tree_four[-four_partition, ]

# building the classification tree with rpart
four_model <- rpart(formula = confidence.elections ~ .,
                             data = four_train,
                             method = "class")

summary(four_model)

# Visualize the decision tree with rpart.plot
rpart.plot(four_model, nn = TRUE)
fancyRpartPlot(four_model, 
               main = "Predicting Confidence in Elections",
               caption = "Confidence Level: 1 = A great deal, 2 = Quite a lot, 3 = Not very much, 4 = Not a lot",
               type = 4)
```

* The response scale is the same among each of the variables included in this decision tree. Confidence in courts and confidence in the United Nations (UN) are used to predict confidence in elections. 

## Confidence in Elections: Leaf Interpretation (L-R)
* High and low confidence in the courts is split almost 50/50, with 51% of respondents reporting at least quite a bit of confidence in the court, and 49% of respondents reporting less than or equal to not very much confidence in the court system. 
* 5% of respondents have a great deal of confidence in the UN, courts, and elections. This means that only 1 in 20 people have a lot of confidence in all 3 bodies in their country.
* 9% of respondents have a great deal of confidence in courts, and quite a lot of confidence in the UN and elections.
* 37% of respondents have quite a lot of confidence in courts and elections.
* 32% of respondents have not very much confidence in courts, or elections.
* 17% of respondents have not a lot of confidence in courts or elections.

#### In summary, results indicate that half of respondents have little trust in public systems like the courts, elections, and the UN, while the other half have moderate-to-high levels of trust in each. A mere 5% of respondents rated all 3 institutions with the highest level of trust, validating the popular culture idea that there is widespread public skepticism concerning political systems.

### Testing Election Confidence Model Accuracy
```{r}
# Variable of importance
four_model$variable.importance # confidence in courts

# Test variable prediction
four_pred<-predict(four_model,newdata=four_test,
                   type = 'class',
                   prob = TRUE)

# Measure model performance
library(caret)
table(four_pred, four_test$confidence.elections)
confusionMatrix(as.factor(four_pred), as.factor(four_test$confidence.elections))
```

Model accuracy is 54%. 

## Interpretation
- Key takeaways, connecting findings and ideas to big picture of values

The tolerance tree illustrates that 78% of respondents responded favorably or neutrally to having immigrants as neighbors. Within this cohort, 27% of respondents do not want immigrants as neighbors but do not think that immigrants increase the risk of terrorism. These people are hesitant about immigrants in their immediate vicinity but don't fear them on a national level. In contrast, 12% of respondents feel that immigration increases the risk of terrorism but feel neutrally or positively about have immigrants as neighbors. All in all, that's 44% of respondents that hold different, somewhat conflicting views about immigrants as neighbors and as a threat to domestic security. Investigating other values that may be driving this discrepancy in immigration attitudes would be a good use of the values dataset. 

A more straightforward decision tree can be found in the political systems tree, which predicts confidence in elections using confidence in the UN and confidence in the courts. A very small percentage (5%) of people responded with high confidence in all 3, and the confidence in elections results were almost exactly 50/50: 51% confident, and 49% possessing little-to-no confidence. This model confirms two hypothesis. First, people are skeptical of their national political institutions across the world, and of the UN, which is purported to be the ultimate champions of international peace and freedom. Second, people tend to hold similar viewpoints towards each of these three political groups. Despite the fact that the courts and elections are highly variable from country to country, and involvement and support from the UN also varries accordingly, people tend to hold the three groups in similar regard.

## Recommendations
- Next, we plan to integrate feedback from Professor Umesh to our final report and presentation
- We will be selecting aspects of our analysis to include in a PowerPoint presentation for classmates next Wednesday, which will require zeroing in on a select few analyses that are visually-focused, namely graphs and decision tress
- Future analysis would touch on those issues that we were not able to cover. These included the relationship between education completed (Q275) and the importance of leisure time (Q3); the relationship between income (Q288), happiness (Q46), and health (Q47); and the relationship between marital status (Q273) and political engagement (Q209 - Q222).