---
title: "Module 2 Final Project â€” Milestone 1: EDA"
author: "Abby Bridgers and Justin Ehringhaus"
date: "July 24, 2022"
output:
  html_document: default
bibliography: "references.bib"
nocite: '@*'
---
 
---

```{r setup, include=FALSE}
# repo: https://github.com/ab6723/aly6040_V02
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(pacman)
p_load(tidyverse)  # usual suite of packages
p_load(ggthemes)   # extra themes
p_load(hrbrthemes) # more extra themes
p_load(skimr)      # alternative to summary(), skims dataset: skim()
p_load(VIM)        # visualization of missing values: aggr()
p_load(corrplot)   # visualization of a correlation matrix: corrplot()
p_load(maps)       # world map
```

---

## Data Preparation

```{r message=FALSE, warning=FALSE}
# importing the entire dataset
wvs <- read_csv("../WVS_Cross-National_Wave_7_csv_v4_0.csv")

# checking first few rows and columns for import success
head(wvs)[,1:5]
```

```{r}
# variables of interest selected and assigned as a subset
wvs_subset <- 
  wvs %>% 
  select(
    Country = B_COUNTRY_ALPHA,
    Longitude = O1_LONGITUDE,
    Latitude = O2_LATITUDE,
    Age = Q262,
    Income.Group = Q288,
    Ethnic.Group = Q290, # see WVS_codebook.pdf for Q290 coding info
    Immigrant = Q263,
    Religion = Q289,
    Marital.Status = Q273,
    Education = Q275,
    Number.Children = Q274,
    Happiness = Q46,
    Health = Q47,
    votes.locally = Q221,
    votes.nationally = Q222,
    cheating.taxes = Q180,
    gov.video.surveillance = Q196,
    gov.email.monitoring = Q197,
    gov.collecting.info = Q198,
    terrorism = Q192,
    death.penalty = Q195,
    suicide = Q187,
    beating.wife = Q189,
    beating.children = Q190,
    homosexuality = Q182,
    prostitution = Q183,
    abortion = Q184,
    divorce = Q185,
    casual.sex = Q193,
    sex.before.marriage = Q186,
    )
```

## Analysis & Interpretation

```{r}
myskim <- skim(wvs_subset)
myskim
```

The subset of the dataset contains `r nrow(wvs_subset)` rows and `r ncol(wvs_subset)` columns.

Most variables are numeric; only `Country` is classified as a character vector. `Longitude` and `Latitude` are missing the most data with a completion rate of `r myskim$complete_rate[2]`, but overall the mean completion rate is `r mean(myskim$complete_rate)`, which signifies that missing data is not too much of an issue for the particular variables under consideration.

As many of the variables are Likert scales, the values are ordinal ranging from 1 to 5, for example, and thus the descriptive statistics generated such as mean, sd, quantiles, and histograms give good indications of the distribution and the characteristics of the data. However, certain variables such as `Ethnic.Group`, `Longitude`, and `Latitude` contains nominal, numeric data, and thus the descriptive statistics generated should be ignored.

```{r}
# unique values and associated counts for categorical data only
wvs_subset_categorical <- 
  wvs_subset %>% 
  select(-Longitude,
         -Latitude)

lapply(wvs_subset_categorical, table)
```

The unique values and associated counts of the categorical data above reveals the dataset is clean. Thankfully, data collection and data entry efforts conducted by the World Values Survey appear to be rigorous, and thus there do not appear to be instances of inappropriately assigned values.

That said, one question for consideration is whether to consider abnormal or atypical experiences as outlier information. For example, if we examine the `Number.Children` variable, we can see the minimum value is `r min(wvs_subset$Number.Children, na.rm = TRUE)` and the maximum value is `r max(wvs_subset$Number.Children, na.rm = TRUE)`. Clearly, that is a high maximum, but if we assume the value was not entered incorrectly, then this is an actual facet of the human experience and should not be treated as an outlier. Removing such data points from our analysis would, in fact, skew our perception of the human experience, and thus for this particular dataset we will opt not to remove any pieces of information with the assumption that data has rigorously been collected and verified by research professionals.

```{r}
# ordinal, numeric data only 
wvs_subset_ordinal <- 
  wvs_subset %>% 
  select(-Longitude,
         -Latitude,
         -Country, 
         -Ethnic.Group, 
         -Religion)

# assessing correlations between ordinal, numeric data
# only including data where pairwise observations are complete (i.e., not including missing data)
cor <- cor(wvs_subset_ordinal, use = "pairwise.complete.obs")
corrplot(cor, 
         method = "circle", 
         insig = "blank", 
         diag = FALSE,
         tl.cex = 0.7) %>% 
    corrRect(name = c('Age', 
                      'votes.locally', 
                      'cheating.taxes', 
                      'homosexuality', 
                      'sex.before.marriage'))
```

The visualization of a correlation matrix above indicates the extent to which each variable, compared to one another, correlates or relates. Darker blue colors represent stronger positive correlations, and darker orange colors represent stronger negative correlations. For visualization purposes, we have bucketed the variables into four groups, albeit it must be noted that by doing so we risk imposing structure where it does not, or should not, exist: the first box contains variables relating to demographics, the second relates to political participation, the third relates to ethical values, and the fourth relates to social views.

There are endless conversations that could be held based off this visualization of a correlation matrix. Some key insights are as follows:

- All variables in the fourth bucket containing those on social views are strongly correlated. This makes sense, as those with similar social views are generally split along the lines of liberal versus conservative thought. For example, it makes sense that those who hold conservative views on sexuality also hold conservative views on marriage, career, and government.
- Education is positively correlated with liberal social views (i.e., higher education = more liberal social views)
- Number of children is negatively correlated with liberal social views (i.e., more children = more conservative social views)
- Education is negatively correlated with number of children (i.e., higher education = less children)
- Voting locally or nationally is negatively correlated with age (i.e., older people participate more in politics)
- Views on terrorism positively correlate with views on domestic abuse (i.e., those who view terrorism favorably also view domestic abuse favorably)

The above observations from the correlation matrix are just several of many possible avenues for exploration. By understanding how different variables correlate, we can begin to explore specific facets of the dataset in more detail.

```{r}
map_color_range <- function(tibl, col, 
                            min = 1, max = 10, 
                            min_color = "green", max_color = "red",
                            shape = 1, size = 0.4) {
  # vector of color gradients with a length of `max`
  colors <- colorRampPalette(c(min_color, max_color))(max)
  # executes points() function for each value between min and max
  for (i in min:max) {
    tibl_subset_col <- 
      tibl %>% 
      filter(col == i) 
    points(tibl_subset_col$Longitude, 
           tibl_subset_col$Latitude, 
           col = alpha(colors[i], 0.4), # colors from color ramp above
           pch = shape, 
           cex = size)
  }
}

map("world")
title(main = "Happiest (Green) vs. Unhappiest (Red)")
map_color_range(wvs_subset, wvs_subset$Happiness, max = 4)
```

Another way of exploring the data is to investigate geospatial relationships using longitude and latitude data paired with variables of interest. For example, the visualization above reveals respondents happiness levels from "very happy" (green points) to "not at all happy" (red).

For another example, we will visualize beliefs on homosexuality below, where greener colors represent those who believe homosexuality is "always justifiable" and redder colors represent those who believe homosexuality is "never justifiable."

```{r}
map("world")
title(main = "Believes Homosexuality is Justifiable (Green) vs. Never Justifiable (Red)")
map_color_range(wvs_subset, 
                wvs_subset$homosexuality, 
                max = 10, min_color = "red", max_color = "green")
```

```{r}
Religion.names <- c('No Religion', 'Roman Catholic', 'Protestant', 'Orthodox',
                    'Jew', 'Muslim', 'Hindu', 'Buddhist', 'Other Christian', 'Other', 'NA')

wvs_subset %>% 
  ggplot +
  aes(x = factor(Number.Children), fill = factor(Religion)) +
  geom_bar(position = "fill") +
  scale_fill_discrete(name = "Religious Denomination",
                      labels = Religion.names) +
  xlab("Number of Children") +
  ylab("Proportion") +
  theme_tufte()
```

- For almost all counts of children, Muslims proportionally dominate other religious denominations.
- Those without a religion generally have fewer children.
- It appears outliers are present, such as families with 12+ children, this can be checked by running:

```{r}
table(wvs_subset$Number.Children, wvs_subset$Religion)
```

- BUT, this data is accurate, and so it may not be wise to consider this an outlier. The dataset is meant to encapsulate human values, the human experience, and actual occurences. So deleting data just because it is outside our view of "what is normal" would, in contrast, skew the data.

```{r}
knitr::knit_exit()
```

## Analysis & Interpretation - Subset 2

```{r}
colnames(wvs_subset)
wvs_subset2 <- wvs %>% 
  select(Country = B_COUNTRY_ALPHA,
    Longitude = O1_LONGITUDE,
    Latitude = O2_LATITUDE,
    Settlement.type = H_SETTLEMENT,
    Country.and.year = S025,
    Town.size = G_TOWNSIZE2,
    Age = Q262,
    Income.group = Q288,
    Importance.leisure.time = Q3,
    Importance.work = Q5,
    Happiness = Q46,
    Health = Q47,
    Confidence.elections = Q76,
    Confidence.courts = Q70,
    Confidence.UN = Q83,
    Environment.vs.econgrow = Q111,
    Job.scarcity.prioritize.nonimmigrants = Q34,
    Immigration.in.country.fills.useful.jobs = Q122,
    Immigration.in.country.strengthens.cultural.div = Q123,
    Immigration.in.country.increases.crime.rate = Q124,
    Immigration.in.country.gives.political.asylum = Q125,
    Immigration.in.country.increases.terrorism.risk = Q126,
    Immigration.in.country.helps.poor.people.est.new.lives = Q127,
    Immigration.in.country.increases.unemployment = Q128,
    Immigration.in.country.brings.social.conflict = Q129,
    Immigration.policy.preference = Q130)
```

# Checking out the subset
```{r}
colnames(wvs_subset2)
skim(wvs_subset2)
```

There are several attributes in the wvs_subset2 that have high rates of missing entries. However, most attributes have a complete rate close to 100%. One of the most answered questions, an inquiry about whether times of job scarcity should see non-immigrants prioritized, had the highest complete rate and lowest standard deviation among the questions in wvs_subset2.

# basic barchart
```{r}
ggplot(wvs_subset2, aes(x=Confidence.courts, y=Age)) + 
  geom_bar(stat = "identity")
```

In the above barchart, confidence in the courts is measured. Confidence ranges from "A great deal" (1) to "Not at all" (4). Most respondents chose 2, meaning they have "Quite a lot" of confidence in the courts. 

# histogram of age of Indonesian respondents 
```{r}
p <- wvs_subset2 %>%
  filter( Country=="IDN" ) %>%
  ggplot( aes(x=Age)) +
    geom_histogram( binwidth=3, fill="#69b3a2", color="#e9ecef", alpha=0.9) +
    ggtitle("Age of Indonesian Respondents") +
    theme_ipsum() +
    theme(
      plot.title = element_text(size=20)
    )
p 
```

In the above histogram, the age of Indonesian respondents is shown. Very few respondents are over the age of 75. The data is clustered around age 30, with the majority of respondents being between ages 25 and 50. The average age in Indonesia is around 30, which aligns with the average age worldwide. Conversely, Germany has a high average age of 48. In the following histogram, I find the age of German respondents to see if the data is clustered around a higher average age than 30 given the much higher country average.

# histogram of age of German respondents 
```{r}
p <- wvs_subset2 %>%
  filter( Country=="DEU" ) %>%
  ggplot( aes(x=Age)) +
    geom_histogram( binwidth=3, fill="blue4", color="#e9ecef", alpha=0.9) +
    ggtitle("Age of German Respondents") +
    theme_ipsum() +
    theme(
      plot.title = element_text(size=20)
    )
p 
```
As expected, the above histogram shows that the average age of german respondents is closer to 50. There may be a difference in viewpoints among those age 30 and 50, making age an important factor for continued consideration in our project. 

# tables & correlation
```{r}
table(wvs_subset2$Age, wvs_subset2$Immigration.in.country.brings.social.conflict)
prop.table(table(wvs_subset2$Age))

data.frame(colnames(wvs_subset2))
wvs_subset3 <- wvs_subset2[c(-1,-2,-3,-7, -11, -12)]
str(wvs_subset3)
cor(wvs_subset3, use = "complete.obs")
```

There is a moderate correlation (p = 0.48) between two questions on immigration. In the immigration questions, respondents were asked to answered their degree of agreement with statements. The moderately positively correlated statements are "Immigration in my country increases crime rate" and "immigration in my country brings social conflict." These questions are answered on the same ordinal scale of 3 options: "disagree", "hard to say", and "agree". For other questions that were not answered on the same ordinal scale, it's a futile exercise to examine correlations because a "2" response on one scale is not equivalent (and often, not even close) to a "2" response on a different scale. An interesting exception to this rule, there is a strong negative correlation between settlement type and town size which are both on a 5-point scale (p = -0.723). A response of "1" to the town size question means the respondent lives in a town of under 5,000 people. A response of "1" to the settlement type question means the respondent lives in the capital city of their country. Therefore, there is a strong inverse relationship between these two attributes. 

# age overlaid with income in prop bar chart
```{r}
library(ggthemes)
Income.details <- c('Lower Step', 'Second Step', 'Third Step', 'Fourth Step', 'Fifth Step', 'Sixth Step', 'Seventh Step', 'Eigth Step', 'Nineth Step', 'Tenth Step', 'Unknown', 'No Answer', 'Not Asked', 'NA')

wvs_subset2 %>% 
  ggplot +
  aes(x = Age, fill = factor(Income.group)) +
  geom_bar(position = "fill") +
  scale_fill_discrete(name = "Income Group",
                      labels = Income.details) +
  xlab("Age") +
  ylab("Proportion") +
  ggtitle("Income Group Proportion By Age")
  theme_hc()
```

The above proportional stacked bar graph allows for visualizing differences in income by age. Respondents were shown cards with their country's income broken down into ten buckets. Since this varies heavily by country, the Wave 7 results do not include any specific numbers. Instead, income is purely comparative. In this chart, several middle income groups appear to fall with increasing age; third through sixth steps noticably decrease from young respondents through middle age respondents to elderly respondents. The highest income, tenth step, appears relatively constant across ages, with a noticable increase in variance from age to age among those in and beyond their 80s. The most common income group appears to be the fifth step, which may mean that most people consider themselves middle-class in the context of their home country. 

# Subset combining our variables in anticipation of working from one subset in Module 3 
xx23 <- merge(wvs_subset, wvs_subset2)
str(xx23)
drop <- c("Income.group")
wvs_subset_mod3 = xx23[,!(names(xx23) %in% drop)]
str(wvs_subset_mod3) 

# 49 variables, 325,552 observations in combined dataframe
---

## TASKS

- Calculate appropriate summary statistics - done
- Create appropriate graphs that will give you insights into the data. - done

Include the answers to following questions:

- What did you do with the data in the context of exploration?
We created subsets with our data to explore and analyze from two perspectives. This allowed us to form separate viewpoints and then share knowledge in order to better understand the steps necessary to prepare the data for further analysis. 

- How many entries are in the dataset?
The Wave 7 WVS dataset contains 552 variables and 87,822 rows. We reduced the number of attributes by about 90%, landing on 49 rows of data. 

- Was there missing data? Duplications? How clean was the data?
- Were their outliers or suspicious data?
- What did you do to clean the data?
While there were missing data and and duplications found in our dataset, we elected to refrain from cleaning the data because doing so may unintentionally falsify the results of the WVS survey. In a typical data cleaning process, outliers are removed to concentrate on the central tendency of the data. Missing data is removed and/or standardized for numerical analysis. Since our data is ordinal, and we are interested in including and analyzing the data holistically, we did not feel that it would be appropriate "clean" the data beyond changing column names, selecting attributes of interest, and ensuring that there weren't a prohibitory amount of NA values found in our subsets of interest. 

- What did you find? What intrigued you about the data? Why does that matter?
- What would your proposed next steps be?
- What business questions do you plan to answer with your data mining?